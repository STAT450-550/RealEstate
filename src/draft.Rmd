---
title: "EDA"
author: "Xuechun Lu, Yuting Wen"
date: "25/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
library(tidyverse)
library(dplyr)
library(here)
library(readxl)
```

1. read the data and aggregate them
```{r}
tax_pct<-read_csv(here("data", "tax_pct.csv"))
assessment_pct<-read_csv(here("data", "assessment_pct.csv"))
# omit 2016
assessment_pct<-na.omit(assessment_pct)
assessment_pct<-assessment_pct[,-c(1)]
names(assessment_pct)[2]<-paste("Municipalities")
tax_pct<-tax_pct[,-c(1)]

```
Note: tax_pct doesn't have Maple Ridge Rural. We decide to treat Maple Ridge Rural and Maple Ridge with the same tax. 


2019 tax pct is missing, we imputed 2019 tax by the average of previous tax pct
```{r}
tax_pct[,4]<-(tax_pct$pct_2017+tax_pct$pct_2018)/2
tax_pct
names(tax_pct)[4]<-paste("pct_2019")
tax_pct
```

```{r}
assessment2017<-assessment_pct  %>%  filter(Year=="2017")
tax2017<-tax_pct[,1:2]
assessment2017<-assessment2017 %>% left_join(tax2017, by = c("Municipalities"))
names(assessment2017)[9]<-paste("tax")

assessment2018<-assessment_pct  %>%  filter(Year=="2018")
tax2018<-tax_pct[,c(1,3)]
assessment2018<-assessment2018 %>% left_join(tax2018, by = c("Municipalities"))
names(assessment2018)[9]<-paste("tax")

assessment2019<-assessment_pct  %>%  filter(Year=="2019")
tax2019<-tax_pct[,c(1,4)]
assessment2019<-assessment2019 %>% left_join(tax2019, by = c("Municipalities"))
names(assessment2019)[9]<-paste("tax")

data_final<-assessment2017 %>% full_join(assessment2018) %>% full_join(assessment2019)
write.csv(data_final, here("data","data_final.csv"))

data_final

```

2019 tax is missing, we imputed 2019 tax using previous values
```{r}
tax_final <- read.csv("~/Desktop/tax_final.csv")
head(tax_final)

tax_modified <- tax_final  %>% mutate(X2019=tax_final$X2018*(1+(((tax_final$X2017-tax_final$X2016)/tax_final$X2016 + (tax_final$X2018-tax_final$X2017)/tax_final$X2017)/2)))
head(tax_modified)
```


2. pct_plots
plot pct change of mill rates
```{r}
dat_1<-data_final %>% subset(Municipalities == "Vancouver") %>% subset(TaxClassCode == "01")
dat_1
dat_1$rate_pct
plot(dat_1$rate_pct)




municipality.list = c(
  "Burnaby", 
  "Coquitlam", 
  "Delta", 
  "Langley - City", 
  "Langley - Township",
  "Maple Ridge",
  "Maple Ridge Rural", 
  "North Vancouver - City",
  "North Vancouver - Dist",
  "Pitt Meadows", 
  "Port Coquitlam", 
  "Port Moody", 
  "Richmond", 
  "Surrey", 
  "Vancouver", 
  "White Rock", 
  "West Vancouver", 
  "Bowen Island", 
  "Anmore", 
  "Belcarra",
  "Lions Bay")
tax.list<-c("01","05","06")
tax.list[1]
# overtall trend for tax class 1
for (i in 1:3){
  plot<-data_final %>% 
  filter(Municipalities %in% municipality.list) %>%
  filter(TaxClassCode == tax.list[i]) %>%
  ggplot(aes(x=Year, y=rate_pct, group=Municipalities, color=Municipalities)) +
    geom_line();
  print(plot)
}


# for each municipality

for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=rate_pct, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}


```

plot pct change of assessment
```{r}
# total trend of assessment 
for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}
```

plot pct change of tax(budget)
```{r}
# total trend for budget 
for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=tax, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}
```


```{r}
# plot rate and assessment for each municipality. 

for (i in 1:21){
  test1<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=rate_pct, group=TaxClassCode, color=TaxClassCode)) +
   geom_line() 
  
  test2<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode)) +
   geom_line() 

  test3<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode))+
   geom_line() 
  
  multiplot(test1,test2,test3)
  
}
```


