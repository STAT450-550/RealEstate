---
title: "EDA"
author: "Xuechun Lu, Yuting Wen"
date: "25/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
libraries and global variables
```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(here)
library(readxl)
```
```{r}

# all municipalities
municipality.list = c(
  "Burnaby", 
  "Coquitlam", 
  "Delta", 
  "Langley - City", 
  "Langley - Township",
  "Maple Ridge",
  "Maple Ridge Rural", 
  "North Vancouver - City",
  "North Vancouver - Dist",
  "Pitt Meadows", 
  "Port Coquitlam", 
  "Port Moody", 
  "Richmond", 
  "Surrey", 
  "Vancouver", 
  "White Rock", 
  "West Vancouver", 
  "Bowen Island", 
  "Anmore", 
  "Belcarra",
  "Lions Bay")
```

1. read the data and aggregate them
```{r}
tax_pct<-read_csv(here("data", "tax_pct.csv"))
assessment_pct<-read_csv(here("data", "assessment_pct.csv"))
# omit 2016
assessment_pct<-na.omit(assessment_pct)
assessment_pct<-assessment_pct[,-c(1)]
names(assessment_pct)[2]<-paste("Municipalities")
tax_pct<-tax_pct[,-c(1)]

```
Note: tax_pct doesn't have Maple Ridge Rural. We decide to treat Maple Ridge Rural and Maple Ridge with the same tax. 


2019 tax pct is missing, we imputed 2019 tax by the average of previous tax pct
```{r}
tax_pct[,4]<-(tax_pct$pct_2017+tax_pct$pct_2018)/2
tax_pct
names(tax_pct)[4]<-paste("pct_2019")
tax_pct
```

```{r}
assessment2017<-assessment_pct  %>%  filter(Year=="2017")
tax2017<-tax_pct[,1:2]
assessment2017<-assessment2017 %>% left_join(tax2017, by = c("Municipalities"))
names(assessment2017)[9]<-paste("tax")

assessment2018<-assessment_pct  %>%  filter(Year=="2018")
tax2018<-tax_pct[,c(1,3)]
assessment2018<-assessment2018 %>% left_join(tax2018, by = c("Municipalities"))
names(assessment2018)[9]<-paste("tax")

assessment2019<-assessment_pct  %>%  filter(Year=="2019")
tax2019<-tax_pct[,c(1,4)]
assessment2019<-assessment2019 %>% left_join(tax2019, by = c("Municipalities"))
names(assessment2019)[9]<-paste("tax")

data_final<-assessment2017 %>% full_join(assessment2018) %>% full_join(assessment2019)
write.csv(data_final, here("data","data_final.csv"))

data_final

```

2019 tax is missing, we imputed 2019 tax using previous values
```{r}
tax_final <- read.csv(here("data","tax_final.csv"))
head(tax_final)

tax_modified <- tax_final  %>% mutate(X2019=tax_final$X2018*(1+(((tax_final$X2017-tax_final$X2016)/tax_final$X2016 + (tax_final$X2018-tax_final$X2017)/tax_final$X2017)/2)))
head(tax_modified)
```

2. val_plots
```{r}
# mill rate vesus year for each municipality and tax class
assessment_aggregate <- read.csv(here("data","assessment_aggregate.csv"))
dat_rate <- assessment_aggregate %>% select(Year, AddressAssessorMunicipalityDesc, TaxClassCode, rate)
head(dat_rate)

dat_rate_1 <- dat_rate %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="1") 
head(dat_rate_1)
rate_class1 <- dat_rate_1 %>% ggplot(aes(x=Year,y=rate,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("mill rate for taxClass 1")
rate_class1

dat_rate_5 <- dat_rate %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="5") 
head(dat_rate_5)
rate_class5 <- dat_rate_5 %>% ggplot(aes(x=Year,y=rate,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("mill rate for taxClass 5")
rate_class5

dat_rate_6 <- dat_rate %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="6") 
head(dat_rate_6)
rate_class6 <- dat_rate_6 %>% ggplot(aes(x=Year,y=rate,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("mill rate for taxClass 6")
rate_class6

multiplot(rate_class1, rate_class5, rate_class6)

# plot assessed value vesus year for each municipality and tax class
dat_assess <- assessment_aggregate %>% select(Year, AddressAssessorMunicipalityDesc, TaxClassCode, assessTotal)
head(dat_assess)

dat_assess_1 <- dat_assess %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="1") 
head(dat_assess_1)
assess_class1 <- dat_assess_1 %>% ggplot(aes(x=Year,y=assessTotal,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("assessTotal for taxClass 1")
assess_class1

dat_assess_5 <- dat_assess %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="5") 
head(dat_assess_5)
assess_class5 <- dat_assess_5 %>% ggplot(aes(x=Year,y=assessTotal,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("assessTotal for taxClass 5")
assess_class5

dat_assess_6 <- dat_assess %>% filter(AddressAssessorMunicipalityDesc %in% municipality.list) %>% filter(TaxClassCode=="6") 
head(dat_assess_6)
assess_class6 <- dat_assess_1 %>% ggplot(aes(x=Year,y=assessTotal,group=AddressAssessorMunicipalityDesc,color=AddressAssessorMunicipalityDesc)) + geom_line() + ggtitle("assessTotal for taxClass 6")
assess_class6

multiplot(assess_class1, assess_class5, assess_class6)



# plot budgets vesus year
dat_tax_long <- gather(tax_modified, Year, TaxAmount, X2016:X2019, factor_key=TRUE)
dat_tax_long
budget_plot <- dat_tax_long %>% ggplot(aes(x=Year,y=TaxAmount,group=Municipalities,color=Municipalities)) + geom_line() +ggtitle("Tax v.s Year")
budget_plot
```


3. pct_plots
plot pct change of mill rates
```{r}
dat_1<-data_final %>% subset(Municipalities == "Vancouver") %>% subset(TaxClassCode == "01")
dat_1
dat_1$rate_pct
plot(dat_1$rate_pct)

tax.list<-c("01","05","06")
tax.list[1]
# overtall trend for tax class 1
for (i in 1:3){
  plot<-data_final %>% 
  filter(Municipalities %in% municipality.list) %>%
  filter(TaxClassCode == tax.list[i]) %>%
  ggplot(aes(x=Year, y=rate_pct, group=Municipalities, color=Municipalities)) +
    geom_line();
  print(plot)
}


# for each municipality

for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=rate_pct, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}


```

plot pct change of assessment
```{r}
# total trend of assessment 
for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}
```

plot pct change of tax(budget)
```{r}
# total trend for budget 
for (i in 1:21){
  plot<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=tax, group=TaxClassCode, color=TaxClassCode)) +
    geom_line()
  print(plot)
}
```


```{r}
# plot rate and assessment for each municipality. 

for (i in 1:21){
  test1<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=rate_pct, group=TaxClassCode, color=TaxClassCode)) +
   geom_line() 
  
  test2<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode)) +
   geom_line() 

  test3<-data_final %>% filter(Municipalities == municipality.list[i]) %>% 
  filter(TaxClassCode %in% tax.list) %>% 
  ggplot(aes(x=Year, y=assessTotal_pct, group=TaxClassCode, color=TaxClassCode))+
   geom_line() 
  
  multiplot(test1,test2,test3)
  
}
```

4. box plots of mill rates, grouped by region
```{r}
rate_boxes <- ggplot(dat_rate, aes(x=AddressAssessorMunicipalityDesc,y=rate,fill=TaxClassCode)) + geom_boxplot() + facet_wrap(~TaxClassCode)
rate_boxes + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


